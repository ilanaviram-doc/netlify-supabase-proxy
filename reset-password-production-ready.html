<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>××™×¤×•×¡ ×¡×™×¡××” - ClinikAI</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            box-sizing: border-box;
            direction: rtl;
            unicode-bidi: embed;
        }
        
        body { 
            font-family: 'Heebo', 'Segoe UI', Arial, sans-serif; 
            display: flex; 
            justify-content: center; 
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            direction: rtl;
            text-align: right;
            line-height: 1.6;
        }
        
        .container { 
            background: white; 
            padding: 40px; 
            border-radius: 15px; 
            width: 100%; 
            max-width: 420px; 
            text-align: center; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.15); 
            border: 1px solid rgba(255,255,255,0.2);
            direction: rtl;
            position: relative;
            overflow: hidden;
        }
        
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #2563eb, #1d4ed8);
        }
        
        .logo {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            font-size: 24px;
            font-weight: 700;
            padding: 15px 30px;
            border-radius: 50px;
            margin-bottom: 30px;
            display: inline-block;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
            position: relative;
        }
        
        .logo::after {
            content: 'ğŸ§ ';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        h2 { 
            margin: 0 0 30px 0; 
            color: #1f2937; 
            font-family: 'Heebo', Arial, sans-serif;
            font-weight: 600;
            font-size: 26px;
        }
        
        .status-container {
            margin: 20px 0;
            min-height: 60px;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            margin: 15px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-radius: 3px;
            transition: width 0.5s ease;
            width: 0%;
        }
        
        .status-msg {
            font-size: 16px;
            font-weight: 500;
            margin: 15px 0;
            min-height: 24px;
            color: #374151;
        }
        
        .status-msg.success { color: #059669; }
        .status-msg.error { color: #dc2626; }
        .status-msg.warning { color: #d97706; }
        
        input { 
            width: 100%; 
            padding: 15px; 
            margin: 15px 0; 
            border: 2px solid #e5e7eb; 
            border-radius: 10px; 
            font-size: 16px; 
            outline: none;
            font-family: 'Heebo', Arial, sans-serif;
            direction: rtl;
            text-align: right;
            transition: all 0.2s;
        }
        
        input:focus { 
            border-color: #3b82f6; 
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); 
            transform: translateY(-1px);
        }
        
        input::placeholder {
            color: #9ca3af;
            font-family: 'Heebo', Arial, sans-serif;
        }
        
        button { 
            width: 100%; 
            padding: 15px; 
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white; 
            border: none; 
            border-radius: 10px; 
            font-size: 17px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.2s;
            font-family: 'Heebo', Arial, sans-serif;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        button:disabled { 
            background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
            color: #9ca3af; 
            cursor: not-allowed; 
            box-shadow: none;
        }
        
        button:hover:not(:disabled) { 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }
        
        .loading-spinner { 
            display: inline-block; 
            width: 18px; 
            height: 18px; 
            border: 2px solid rgba(255,255,255,0.3); 
            border-radius: 50%; 
            border-top: 2px solid white; 
            animation: spin 1s linear infinite; 
            margin-left: 10px;
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        .message { 
            padding: 15px; 
            border-radius: 10px; 
            margin: 15px 0; 
            font-size: 14px; 
            font-family: 'Heebo', Arial, sans-serif;
            direction: rtl;
            text-align: right;
            border: 1px solid;
            display: none;
        }
        
        .message.error { 
            color: #dc2626; 
            background: #fee2e2; 
            border-color: #fecaca;
        }
        
        .message.success { 
            color: #059669; 
            background: #d1fae5; 
            border-color: #a7f3d0;
        }
        
        .message.warning { 
            color: #d97706; 
            background: #fef3c7; 
            border-color: #fed7aa;
        }
        
        .message.info { 
            color: #0369a1; 
            background: #dbeafe; 
            border-color: #93c5fd;
        }
        
        .step-indicator {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            gap: 10px;
        }
        
        .step {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e5e7eb;
            transition: all 0.3s;
        }
        
        .step.active {
            background: #3b82f6;
            transform: scale(1.2);
        }
        
        .step.completed {
            background: #059669;
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            h2 {
                font-size: 22px;
            }
            
            .logo {
                font-size: 20px;
                padding: 12px 25px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">ClinikAI</div>
        <h2>××™×¤×•×¡ ×¡×™×¡××”</h2>
        
        <div class="step-indicator">
            <div class="step" id="step-1"></div>
            <div class="step" id="step-2"></div>
            <div class="step" id="step-3"></div>
            <div class="step" id="step-4"></div>
        </div>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progress"></div>
        </div>
        
        <div class="status-container">
            <div id="status-msg" class="status-msg">×××ª×¨ ×˜×•×§×Ÿ ××‘×˜×—×”...</div>
            <div id="message-box" class="message"></div>
        </div>
        
        <form id="reset-form">
            <input 
                type="password" 
                id="password" 
                placeholder="×”×›× ×¡ ×¡×™×¡××” ×—×“×©×” (×œ×¤×—×•×ª 6 ×ª×•×•×™×)" 
                required 
                disabled 
                autocomplete="new-password"
                minlength="6"
            />
            <button type="submit" id="btn" disabled>×‘×˜×¢×™× ×”...</button>
        </form>
    </div>

    <script>
        // ×”×’×“×¨×•×ª Supabase
        const supabaseUrl = 'https://rmgtegimphpjzxcflotn.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtZ3RlZ2ltcGhwanp4Y2Zsb3RuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwOTUwOTIsImV4cCI6MjA3NzY3MTA5Mn0.ccIorGjQCIuuAF5E8fhUKFYRXT0mexSoucfTSzIHfM8';
        
        const sb = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        // ××©×ª× ×™ ××¢×¨×›×ª
        let appState = {
            currentStep: 0,
            maxSteps: 4,
            isReady: false,
            sessionData: null
        };

        // ××œ×× ×˜×™× ×‘×××©×§
        const UI = {
            statusMsg: document.getElementById('status-msg'),
            messageBox: document.getElementById('message-box'),
            progressBar: document.getElementById('progress'),
            passwordInput: document.getElementById('password'),
            submitButton: document.getElementById('btn'),
            steps: {
                1: document.getElementById('step-1'),
                2: document.getElementById('step-2'),
                3: document.getElementById('step-3'),
                4: document.getElementById('step-4')
            }
        };

        // ×¤×•× ×§×¦×™×•×ª ×××©×§ ××©×ª××©
        function updateProgress(step, message, type = 'info') {
            appState.currentStep = step;
            const percentage = (step / appState.maxSteps) * 100;
            UI.progressBar.style.width = percentage + '%';
            
            // ×¢×“×›×•×Ÿ ××™× ×“×™×§×˜×•×¨×™ ×©×œ×‘×™×
            Object.keys(UI.steps).forEach(stepNum => {
                const stepElement = UI.steps[stepNum];
                stepElement.classList.remove('active', 'completed');
                
                if (parseInt(stepNum) < step) {
                    stepElement.classList.add('completed');
                } else if (parseInt(stepNum) === step) {
                    stepElement.classList.add('active');
                }
            });
            
            // ×¢×“×›×•×Ÿ ×”×•×“×¢×ª ×¡×˜×˜×•×¡
            UI.statusMsg.innerText = message;
            UI.statusMsg.className = `status-msg ${type}`;
            
            console.log(`Step ${step}/${appState.maxSteps}: ${message}`);
        }

        function showMessage(message, type = 'info') {
            UI.messageBox.innerText = message;
            UI.messageBox.className = `message ${type}`;
            UI.messageBox.style.display = 'block';
        }

        function hideMessage() {
            UI.messageBox.style.display = 'none';
        }

        function setButtonState(loading, text, color = null) {
            UI.submitButton.disabled = loading || !appState.isReady;
            
            if (loading) {
                UI.submitButton.innerHTML = `<span class="loading-spinner"></span>${text}`;
            } else {
                UI.submitButton.innerText = text;
            }
            
            if (color) {
                UI.submitButton.style.background = color;
            }
        }

        function enableForm() {
            appState.isReady = true;
            UI.passwordInput.disabled = false;
            UI.passwordInput.style.borderColor = '#059669';
            setButtonState(false, '×¢×“×›×Ÿ ×¡×™×¡××”');
            updateProgress(4, '××•×›×Ÿ ×œ×¢×“×›×•×Ÿ ×¡×™×¡××”!', 'success');
            showMessage('×”×–×™×”×•×™ ×”×•×©×œ× ×‘×”×¦×œ×—×”. ×›×¢×ª × ×™×ª×Ÿ ×œ×¢×“×›×Ÿ ××ª ×”×¡×™×¡××”.', 'success');
        }

        // ×¤×•× ×§×¦×™×™×ª ××™×¦×•×™ ×˜×•×§× ×™× ××ª×§×“××ª - ××•×ª×• ×§×•×“ ×©×¢×‘×“ ×™×“× ×™×ª
        function extractTokensFromURL() {
            const url = window.location.href;
            console.log('ğŸ” ××—×¤×© ×˜×•×§× ×™× ×‘×›×ª×•×‘×ª:', url.substring(0, 100) + '...');
            
            // ×©×™×˜×” ×—×–×§×” ×©××˜×¤×œ×ª ×‘-# ×›×¤×•×œ
            const accessMatch = url.match(/access_token=([^&\s#]+)/);
            const refreshMatch = url.match(/refresh_token=([^&\s#]+)/);
            
            if (accessMatch && accessMatch[1]) {
                const tokens = {
                    access_token: decodeURIComponent(accessMatch[1]),
                    refresh_token: refreshMatch ? decodeURIComponent(refreshMatch[1]) : null
                };
                
                console.log('âœ… ×˜×•×§× ×™× × ××¦××• ×‘×”×¦×œ×—×”');
                console.log('ğŸ“Š ××•×¨×š access token:', tokens.access_token.length);
                console.log('ğŸ“Š ×§×™×™× refresh token:', !!tokens.refresh_token);
                
                return tokens;
            }
            
            console.log('âŒ ×œ× × ××¦××• ×˜×•×§× ×™× ×‘×›×ª×•×‘×ª');
            return null;
        }

        // ×¤×•× ×§×¦×™×™×ª ×™×¦×™×¨×ª ×¡×©×Ÿ - ××•×ª×• ×§×•×“ ×©×¢×‘×“ ×™×“× ×™×ª
        async function createSession(tokens) {
            try {
                console.log('ğŸ”„ ×™×•×¦×¨ ×¡×©×Ÿ ×¢× ×˜×•×§× ×™×...');
                
                const { data, error } = await sb.auth.setSession({
                    access_token: tokens.access_token,
                    refresh_token: tokens.refresh_token || ''
                });
                
                if (error) {
                    console.error('âŒ ×™×¦×™×¨×ª ×¡×©×Ÿ × ×›×©×œ×”:', error.message);
                    throw error;
                }
                
                if (!data.session) {
                    throw new Error('×œ× × ×•×¦×¨ ×¡×©×Ÿ');
                }
                
                console.log('âœ… ×¡×©×Ÿ × ×•×¦×¨ ×‘×”×¦×œ×—×”!');
                console.log('ğŸ‘¤ ××©×ª××©:', data.session.user?.email);
                
                appState.sessionData = data.session;
                return data.session;
                
            } catch (error) {
                console.error('âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ×¡×©×Ÿ:', error.message);
                throw error;
            }
        }

        // ×¤×•× ×§×¦×™×™×ª ×¢×“×›×•×Ÿ ×¡×™×¡××”
        async function updatePassword(newPassword) {
            if (!appState.sessionData) {
                throw new Error('××™×Ÿ ×¡×©×Ÿ ×¤×¢×™×œ');
            }
            
            try {
                console.log('ğŸ”„ ××¢×“×›×Ÿ ×¡×™×¡××”...');
                
                // ×‘×“×™×§×ª ×¡×©×Ÿ × ×•×›×—×™
                const { data: currentSession } = await sb.auth.getSession();
                if (!currentSession.session) {
                    throw new Error('×”×¡×©×Ÿ ×¤×’ ×ª×•×§×£');
                }
                
                const { data, error } = await sb.auth.updateUser({ 
                    password: newPassword 
                });
                
                if (error) {
                    console.error('âŒ ×¢×“×›×•×Ÿ ×¡×™×¡××” × ×›×©×œ:', error.message);
                    throw error;
                }
                
                console.log('ğŸ‰ ×¡×™×¡××” ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”!');
                return true;
                
            } catch (error) {
                console.error('âŒ ×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¡×™×¡××”:', error.message);
                throw error;
            }
        }

        // ×¤×•× ×§×¦×™×” ×¨××©×™×ª - ××‘×•×¡×¡×ª ×¢×œ ×”×§×•×“ ×©×¢×‘×“ ×™×“× ×™×ª
        async function initializePasswordReset() {
            try {
                // ×©×œ×‘ 1: ××™×¦×•×™ ×˜×•×§× ×™×
                updateProgress(1, '××—×¤×© ×˜×•×§×Ÿ ××‘×˜×—×”...', 'info');
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const tokens = extractTokensFromURL();
                if (!tokens) {
                    throw new Error('×œ× × ××¦× ×˜×•×§×Ÿ ××‘×˜×—×” ×ª×§×™×Ÿ ×‘×›×ª×•×‘×ª. ×× × ×œ×—×¥ ×©×•×‘ ×¢×œ ×”×§×™×©×•×¨ ×‘××™×™×œ.');
                }
                
                // ×©×œ×‘ 2: ×™×¦×™×¨×ª ×¡×©×Ÿ
                updateProgress(2, '××ª×—×‘×¨ ×œ×©×¨×ª...', 'info');
                await new Promise(resolve => setTimeout(resolve, 300));
                
                const session = await createSession(tokens);
                
                // ×©×œ×‘ 3: ××™××•×ª ×—×™×‘×•×¨
                updateProgress(3, '××××ª ×–×”×•×ª...', 'info');
                await new Promise(resolve => setTimeout(resolve, 400));
                
                // ×©×œ×‘ 4: ×”×›× ×ª ×”×××©×§
                enableForm();
                
                // × ×™×§×•×™ ×›×ª×•×‘×ª (×œ××—×¨ ×©×—×™×œ×¦× ×• ×”×›×œ)
                const cleanUrl = window.location.origin + window.location.pathname;
                window.history.replaceState({}, document.title, cleanUrl);
                
            } catch (error) {
                console.error('âŒ ×›×©×œ ×‘××ª×—×•×œ:', error.message);
                updateProgress(0, '×©×’×™××” ×‘×ª×”×œ×™×š ×”××ª×—×•×œ', 'error');
                showMessage(error.message, 'error');
                
                // ×”×¦×’×ª ×”×•×¨××•×ª ×œ×¤×ª×¨×•×Ÿ
                setTimeout(() => {
                    showMessage('×× × × ×¡×”: 1) ×œ×—×¥ ×¨×¢× ×•×Ÿ ×‘×“×¤×“×¤×Ÿ 2) ×œ×—×¥ ×©×•×‘ ×¢×œ ×”×§×™×©×•×¨ ×‘××™×™×œ 3) ×‘×§×© ××™×¤×•×¡ ×¡×™×¡××” ×—×“×©', 'warning');
                }, 2000);
            }
        }

        // ×××–×™×Ÿ ×œ×˜×•×¤×¡
        document.getElementById('reset-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const newPassword = UI.passwordInput.value.trim();
            
            // ×•×œ×™×“×¦×™×•×ª
            if (!newPassword) {
                showMessage('×× × ×”×›× ×¡ ×¡×™×¡××” ×—×“×©×”', 'warning');
                UI.passwordInput.focus();
                return;
            }
            
            if (newPassword.length < 6) {
                showMessage('×”×¡×™×¡××” ×—×™×™×‘×ª ×œ×”×›×™×œ ×œ×¤×—×•×ª 6 ×ª×•×•×™×', 'warning');
                UI.passwordInput.focus();
                return;
            }
            
            try {
                setButtonState(true, '××¢×“×›×Ÿ ×¡×™×¡××”');
                hideMessage();
                updateProgress(4, '××¢×“×›×Ÿ ×¡×™×¡××”...', 'info');
                
                await updatePassword(newPassword);
                
                // ×”×¦×œ×—×”!
                setButtonState(false, '×¡×™×¡××” ×¢×•×“×›× ×”!', 'linear-gradient(135deg, #16a34a 0%, #15803d 100%)');
                updateProgress(4, '×¡×™×¡××” ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”!', 'success');
                showMessage('×”×¡×™×¡××” ×©×•× ×ª×” ×‘×”×¦×œ×—×”! ××¢×‘×™×¨ ××•×ª×š ×œ××ª×¨...', 'success');
                
                // ×”×¢×‘×¨×” ×œ××ª×¨ ×”×¨××©×™
                setTimeout(() => {
                    console.log('ğŸ”„ ××¢×‘×™×¨ ×œ××ª×¨ ×”×¨××©×™...');
                    window.location.href = 'https://clinikai.tiiny.site';
                }, 2500);
                
            } catch (error) {
                console.error('âŒ ×›×©×œ ×‘×¢×“×›×•×Ÿ ×¡×™×¡××”:', error.message);
                setButtonState(false, '×¢×“×›×Ÿ ×¡×™×¡××”');
                updateProgress(4, '×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¡×™×¡××”', 'error');
                
                let errorMessage = error.message;
                if (error.message.includes('session') || error.message.includes('expired')) {
                    errorMessage = '×”×¡×©×Ÿ ×¤×’ ×ª×•×§×£. ×× × ×œ×—×¥ ×©×•×‘ ×¢×œ ×”×§×™×©×•×¨ ×‘××™×™×œ.';
                } else if (error.message.includes('weak') || error.message.includes('password')) {
                    errorMessage = '×”×¡×™×¡××” ×œ× ×¢×•××“×ª ×‘×“×¨×™×©×•×ª ×”××‘×˜×—×”. × ×¡×” ×¡×™×¡××” ×—×–×§×” ×™×•×ª×¨.';
                }
                
                showMessage(errorMessage, 'error');
            }
        });

        // ×”×ª×—×œ×ª ×”×ª×”×œ×™×š
        window.addEventListener('load', () => {
            console.log('ğŸš€ ClinikAI Password Reset - ××ª×—×™×œ ×ª×”×œ×™×š ××™×¤×•×¡ ×¡×™×¡××”');
            setTimeout(initializePasswordReset, 300);
        });

        // ×˜×™×¤×•×œ ×‘×©×’×™××•×ª ×’×œ×•×‘×œ×™×•×ª
        window.addEventListener('error', (event) => {
            console.error('âŒ ×©×’×™××” ×’×œ×•×‘×œ×™×ª:', event.message);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('âŒ Promise × ×“×—×”:', event.reason);
        });
    </script>
</body>
</html>